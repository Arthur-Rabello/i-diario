$(function () {
  var flashMessages = new FlashMessages(),
    $disciplineDiv = $("[data-discipline]"),
    $classroom = $("#absence_justification_report_form_classroom_id"),
    $discipline = $("#absence_justification_report_form_discipline_id");

  $classroom.on('change', function (e) {
    var params = { classroom_id: e.val };
    var classroom_id = $classroom.select2('val')

    $discipline.val('').select2({ data: [] });

    if (!_.isEmpty(classroom_id)) {
      checkExamRule(params);

      fetchDisciplines(classroom_id);
    }
  });

  var fetchExamRule = function (params, callback) {
    $.getJSON('/exam_rules?' + $.param(params)).always(function (data) {
      callback(data);
    });
  };

  var checkExamRule = function (params) {
    fetchExamRule(params, function (data) {
      var examRule = data.exam_rule;
      if (!$.isEmptyObject(examRule)) {
        if (examRule.frequency_type == 2 || examRule.allow_frequency_by_discipline) {
          $disciplineDiv.show();
        } else {
          $disciplineDiv.hide();
        }
      } else {
        $disciplineDiv.hide();
      }
    });
  }

  function fetchDisciplines(classroom_id) {
    $.ajax({
      url: Routes.disciplines_pt_br_path({ classroom_id: classroom_id, format: 'json' }),
      success: handleFetchDisciplinesSuccess,
      error: handleFetchDisciplinesError
    });
  };

  function handleFetchDisciplinesSuccess(disciplines) {
    var selectedDisciplines = _.map(disciplines, function (discipline) {
      return { id: discipline['id'], text: discipline['description'] };
    });

    $discipline.select2({ data: selectedDisciplines });

    // Define a primeira opção como selecionada por padrão
    $discipline.val(selectedDisciplines[0].id).trigger('change');
  };

  function handleFetchDisciplinesError() {
    flashMessages.error('Ocorreu um erro ao buscar as disciplinas da turma selecionada.');
  };

  if ($classroom.val() != '' && $classroom.val() != 'empty') {
    checkExamRule({ classroom_id: $classroom.val() });
  } else {
    toggleDiscipline(false);
  }

  function toggleDiscipline(show) {
    if (show) {
      $disciplineDiv.show();
    } else {
      $disciplineDiv.hide();
    }
  }
});
